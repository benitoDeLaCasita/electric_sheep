Vagrant.configure("2") do |config|

  config.vm.define "ubuntu32" do |web|
    web.vm.box = "ubuntu/trusty32"
  end

  config.vm.define "ubuntu64" do |db|
    db.vm.box = "ubuntu/trusty64"
  end

  config.omnibus.chef_version = :latest
  config.vm.provider "virtualbox" do |v|
    v.memory = 4096
    v.cpus = 2
    v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
  end

  config.ssh.shell = "bash -c 'BASH_ENV=/etc/profile exec bash'"
  config.vm.provision :shell, inline: "sudo locale-gen fr_FR.UTF-8 && sudo dpkg-reconfigure locales"

  config.vm.provision :chef_solo do |chef|
    chef.cookbooks_path = ["cookbooks"]
    chef.add_recipe "apt"
  end

  config.vm.synced_folder File.expand_path(File.join(File.dirname(__FILE__), "../../")), "/tmp/electric_sheep/"

  config.vm.provision :shell, privileged: true, inline: <<-SCRIPT
    apt-get install -y python-software-properties
    apt-add-repository ppa:brightbox/ruby-ng
    apt-get update
    apt-get install -y ruby2.1 git ruby2.1-dev ruby-dev build-essential autoconf zlib1g-dev
    gem install bundler --no-rdoc --no-ri
    gem install omnibus --no-rdoc --no-ri
    git config --global user.email "humans@electricsheep.io"
    git config --global user.name "Electric Sheep IO"
    mkdir -p /opt/electric_sheep /var/cache/omnibus
    rm -rf /var/cache/omnibus/pkg/*
    chown vagrant:vagrant /opt/electric_sheep
    chown vagrant:vagrant /var/cache/omnibus
    cd /tmp/electric_sheep/build
    bundle install
    bundle exec omnibus build electric_sheep

    echo "NOW TEST PACKAGE"
    sudo dpkg -r electric-sheep
    electric_sheep help
    if [ $? == 0 ]
      then
      echo "electric_sheep uninstall failed"
      exit 1
    fi
    sudo dpkg -i /var/cache/omnibus/pkg/*.deb
    electric_sheep help
    if [ $? != 0 ]
    then
      echo "electric_sheep install failed"
      exit 1
    fi

  SCRIPT
end
